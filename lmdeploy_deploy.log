2025-05-02 10:59:47,392 - lmdeploy - [37mINFO[0m - async_engine.py:142 - input backend=turbomind, backend_config=TurbomindEngineConfig(dtype='auto', model_format=None, tp=4, session_len=None, max_batch_size=256, cache_max_entry_count=0.1, cache_chunk_size=-1, cache_block_seq_len=64, enable_prefix_caching=False, quant_policy=0, rope_scaling_factor=0.0, use_logn_attn=False, download_dir=None, revision=None, max_prefill_token_num=8192, num_tokens_per_iter=0, max_prefill_iters=1)
2025-05-02 10:59:47,393 - lmdeploy - [37mINFO[0m - async_engine.py:144 - input chat_template_config=None
2025-05-02 10:59:47,419 - lmdeploy - [37mINFO[0m - async_engine.py:154 - updated chat_template_onfig=ChatTemplateConfig(model_name='qwen', system=None, meta_instruction=None, eosys=None, user=None, eoh=None, assistant=None, eoa=None, separator=None, capability=None, stop_words=None)
2025-05-02 10:59:47,419 - lmdeploy - [37mINFO[0m - turbomind.py:301 - model_source: hf_model
/mnt/code/users/liamding/tools/conda_install/anaconda3/envs/vlm_llava_lmdeploy/lib/python3.9/site-packages/_distutils_hack/__init__.py:55: UserWarning: Reliance on distutils from stdlib is deprecated. Users must rely on setuptools to provide the distutils module. Avoid importing distutils or import setuptools first, and avoid setting SETUPTOOLS_USE_DISTUTILS=stdlib. Register concerns at https://github.com/pypa/setuptools/issues/new?template=distutils-deprecation.yml
  warnings.warn(
2025-05-02 10:59:52,606 - lmdeploy - [37mINFO[0m - turbomind.py:200 - turbomind model config:

{
  "model_config": {
    "model_name": "",
    "chat_template": "",
    "model_arch": "Qwen2ForCausalLM",
    "head_num": 28,
    "kv_head_num": 4,
    "hidden_units": 3584,
    "vocab_size": 152064,
    "embedding_size": 152064,
    "num_layer": 28,
    "inter_size": 18944,
    "norm_eps": 1e-06,
    "attn_bias": 1,
    "start_id": 151643,
    "end_id": 151645,
    "size_per_head": 128,
    "group_size": 128,
    "weight_type": "bfloat16",
    "session_len": 32768,
    "tp": 4,
    "model_format": "hf",
    "expert_num": 0,
    "expert_inter_size": 0,
    "experts_per_token": 0,
    "moe_shared_gate": 0,
    "moe_norm_topk": 0
  },
  "attention_config": {
    "rotary_embedding": 128,
    "rope_theta": 1000000.0,
    "attention_factor": -1.0,
    "max_position_embeddings": 32768,
    "original_max_position_embeddings": 0,
    "rope_scaling_type": "",
    "rope_scaling_factor": 0.0,
    "use_dynamic_ntk": 0,
    "low_freq_factor": 1.0,
    "high_freq_factor": 1.0,
    "beta_fast": 32.0,
    "beta_slow": 1.0,
    "use_logn_attn": 0,
    "cache_block_seq_len": 64
  },
  "lora_config": {
    "lora_policy": "",
    "lora_r": 0,
    "lora_scale": 0.0,
    "lora_max_wo_r": 0,
    "lora_rank_pattern": "",
    "lora_scale_pattern": ""
  },
  "engine_config": {
    "dtype": "auto",
    "model_format": null,
    "tp": 4,
    "session_len": null,
    "max_batch_size": 256,
    "cache_max_entry_count": 0.1,
    "cache_chunk_size": -1,
    "cache_block_seq_len": 64,
    "enable_prefix_caching": false,
    "quant_policy": 0,
    "rope_scaling_factor": 0.0,
    "use_logn_attn": false,
    "download_dir": null,
    "revision": null,
    "max_prefill_token_num": 8192,
    "num_tokens_per_iter": 8192,
    "max_prefill_iters": 4
  }
}
[TM][WARNING] [LlamaTritonModel] `max_context_token_num` is not set, default to 32768.
[TM][INFO] Model: 
head_num: 28
kv_head_num: 4
size_per_head: 128
inter_size: 18944
num_layer: 28
vocab_size: 152064
attn_bias: 1
max_batch_size: 256
max_prefill_token_num: 8192
max_context_token_num: 32768
num_tokens_per_iter: 8192
max_prefill_iters: 4
session_len: 32768
cache_max_entry_count: 0.1
cache_block_seq_len: 64
cache_chunk_size: -1
enable_prefix_caching: 0
start_id: 151643
tensor_para_size: 4
pipeline_para_size: 1
enable_custom_all_reduce: 0
model_name: 
model_dir: 
quant_policy: 0
group_size: 128
expert_num: 0
expert_per_token: 0
moe_method: 1

[TM][INFO] TM_FUSE_SILU_ACT=1
2025-05-02 10:59:54,918 - lmdeploy - [33mWARNING[0m - turbomind.py:231 - get 849 model params
Convert to turbomind format:   0%|          | 0/28 [00:00<?, ?it/s]Convert to turbomind format:   4%|â–Ž         | 1/28 [00:01<00:40,  1.49s/it]Convert to turbomind format:   7%|â–‹         | 2/28 [00:02<00:32,  1.23s/it]Convert to turbomind format:  11%|â–ˆ         | 3/28 [00:03<00:28,  1.14s/it]Convert to turbomind format:  14%|â–ˆâ–        | 4/28 [00:04<00:26,  1.09s/it]Convert to turbomind format:  18%|â–ˆâ–Š        | 5/28 [00:05<00:24,  1.07s/it]Convert to turbomind format:  21%|â–ˆâ–ˆâ–       | 6/28 [00:06<00:22,  1.03s/it]Convert to turbomind format:  25%|â–ˆâ–ˆâ–Œ       | 7/28 [00:08<00:29,  1.39s/it]Convert to turbomind format:  29%|â–ˆâ–ˆâ–Š       | 8/28 [00:09<00:25,  1.29s/it]Convert to turbomind format:  32%|â–ˆâ–ˆâ–ˆâ–      | 9/28 [00:10<00:23,  1.21s/it]Convert to turbomind format:  36%|â–ˆâ–ˆâ–ˆâ–Œ      | 10/28 [00:11<00:20,  1.15s/it]Convert to turbomind format:  39%|â–ˆâ–ˆâ–ˆâ–‰      | 11/28 [00:12<00:18,  1.11s/it]Convert to turbomind format:  43%|â–ˆâ–ˆâ–ˆâ–ˆâ–Ž     | 12/28 [00:14<00:18,  1.14s/it]Convert to turbomind format:  46%|â–ˆâ–ˆâ–ˆâ–ˆâ–‹     | 13/28 [00:15<00:16,  1.10s/it]Convert to turbomind format:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 14/28 [00:16<00:15,  1.08s/it]Convert to turbomind format:  54%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž    | 15/28 [00:17<00:14,  1.12s/it]Convert to turbomind format:  57%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹    | 16/28 [00:18<00:13,  1.13s/it]Convert to turbomind format:  61%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    | 17/28 [00:19<00:12,  1.10s/it]Convert to turbomind format:  64%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–   | 18/28 [00:20<00:10,  1.08s/it]Convert to turbomind format:  68%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š   | 19/28 [00:21<00:09,  1.06s/it]Convert to turbomind format:  71%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–  | 20/28 [00:22<00:08,  1.04s/it]Convert to turbomind format:  75%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ  | 21/28 [00:23<00:07,  1.02s/it]Convert to turbomind format:  79%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š  | 22/28 [00:24<00:06,  1.01s/it]Convert to turbomind format:  82%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ– | 23/28 [00:25<00:05,  1.10s/it]Convert to turbomind format:  86%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ | 24/28 [00:26<00:04,  1.12s/it]Convert to turbomind format:  89%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰ | 25/28 [00:27<00:03,  1.08s/it]Convert to turbomind format:  93%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž| 26/28 [00:28<00:02,  1.04s/it]Convert to turbomind format:  96%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹| 27/28 [00:29<00:01,  1.03s/it]Convert to turbomind format: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 28/28 [00:30<00:00,  1.02s/it]                                                                            [TM][INFO] [LlamaWeight<T>::prepare] workspace size: 67895296

[TM][INFO] [LlamaWeight<T>::prepare] workspace size: 67895296

[TM][INFO] [LlamaWeight<T>::prepare] workspace size: 67895296

[TM][INFO] [LlamaWeight<T>::prepare] workspace size: 67895296

[WARNING] gemm_config.in is not found; using default GEMM algo
[WARNING] gemm_config.in is not found; using default GEMM algo
[WARNING] gemm_config.in is not found; using default GEMM algo
[WARNING] gemm_config.in is not found; using default GEMM algo
[TM][INFO] [BlockManager] block_size = 0 MB
[TM][INFO] [BlockManager] max_block_count = 6955
[TM][INFO] [BlockManager] chunk_size = 6955
[TM][INFO] [BlockManager] block_size = 0 MB
[TM][INFO] [BlockManager] max_block_count = 6955
[TM][INFO] [BlockManager] chunk_size = 6955
[TM][INFO] [BlockManager] block_size = 0 MB
[TM][INFO] [BlockManager] max_block_count = 6955
[TM][INFO] [BlockManager] chunk_size = 6955
[TM][INFO] [BlockManager] block_size = 0 MB
[TM][INFO] [BlockManager] max_block_count = 6955
[TM][INFO] [BlockManager] chunk_size = 6955
[TM][INFO] LlamaBatch<T>::Start()
[TM][INFO] LlamaBatch<T>::Start()
[TM][INFO] LlamaBatch<T>::Start()
[TM][INFO] LlamaBatch<T>::Start()
[TM][INFO] [Gemm2] Tuning sequence: 8, 16, 32, 48, 64, 96, 128, 192, 256, 384, 512, 768, 1024, 1536, 2048, 3072, 4096, 6144, 8192
[TM][INFO] [Gemm2] 8
[TM][INFO] [Gemm2] 16
[TM][INFO] [Gemm2] 32
[TM][INFO] [Gemm2] 48
[TM][INFO] [Gemm2] 64
[TM][INFO] [Gemm2] 96
[TM][INFO] [Gemm2] 128
[TM][INFO] [Gemm2] 192
[TM][INFO] [Gemm2] 256
[TM][INFO] [Gemm2] 384
[TM][INFO] [Gemm2] 512
[TM][INFO] [Gemm2] 768
[TM][INFO] [Gemm2] 1024
[TM][INFO] [Gemm2] 1536
[TM][INFO] [Gemm2] 2048
[TM][INFO] [Gemm2] 3072
[TM][INFO] [Gemm2] 4096
[TM][INFO] [Gemm2] 6144
[TM][INFO] [Gemm2] 8192
[TM][INFO] [Gemm2] Tuning finished in 0.34 seconds.
2025-05-02 11:00:29,203 - lmdeploy - [37mINFO[0m - async_engine.py:168 - updated backend_config=TurbomindEngineConfig(dtype='auto', model_format=None, tp=4, session_len=None, max_batch_size=256, cache_max_entry_count=0.1, cache_chunk_size=-1, cache_block_seq_len=64, enable_prefix_caching=False, quant_policy=0, rope_scaling_factor=0.0, use_logn_attn=False, download_dir=None, revision=None, max_prefill_token_num=8192, num_tokens_per_iter=8192, max_prefill_iters=4)
HINT:    Please open [93m[1mhttp://0.0.0.0:23335[0m in a browser for detailed api usage!!!
HINT:    Please open [93m[1mhttp://0.0.0.0:23335[0m in a browser for detailed api usage!!!
HINT:    Please open [93m[1mhttp://0.0.0.0:23335[0m in a browser for detailed api usage!!!
INFO:     Started server process [1115798]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
ERROR:    [Errno 98] error while attempting to bind on address ('0.0.0.0', 23335): address already in use
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
[TM][INFO] [InternalThreadEntry] stop requested.
[TM][INFO] [InternalThreadEntry] stop requested.
[TM][INFO] [InternalThreadEntry] stop requested.
[TM][INFO] [InternalThreadEntry] stop requested.
[TM][INFO] [OutputThreadEntry] stop requested.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           INFO:     127.0.0.1:60790 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:60806 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:33582 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:33592 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:54062 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:54068 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:54080 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:48300 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:44244 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:44246 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:40472 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:40480 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:58732 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:47570 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:47574 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:47582 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:58376 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:58388 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:58404 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:58414 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:52326 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:60776 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:60790 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:58006 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:58018 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:50182 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:50190 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:48696 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:48698 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:48702 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:51994 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:52004 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:42052 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:42056 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:46876 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:45414 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:45428 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:46574 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:46590 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:36490 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:36506 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:40346 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:40360 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:48960 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:42284 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:42288 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:54994 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:55010 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:35414 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:35418 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:53632 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:58920 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:58922 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:59744 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:59748 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:53932 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:53940 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:53952 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:50516 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:50532 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:44784 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:44994 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:46424 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:46438 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:51038 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:51054 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:50628 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:50630 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:50642 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:40562 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:55572 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:55576 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:57346 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:57356 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
INFO:     127.0.0.1:57360 - "POST /v1/chat/completions HTTP/1.1" 404 Not Found
